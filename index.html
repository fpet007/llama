<html><head><base href="https://deepinfra.com/"></base>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<style>
:root {
  --bg-color: #f0f0f0;
  --text-color: #333;
  --chat-bg: white;
  --user-msg-bg: #e6f2ff;
  --ai-msg-bg: #f0f0f0;
  --input-bg: #f9f9f9;
  --button-bg: #0066cc;
  --button-color: white;
  --button-hover: #0052a3;
  --header-bg: #0066cc;
  --header-color: white;
  --code-bg: #f4f4f4;
  --sidebar-bg: #f9f9f9;
  --sidebar-hover: #e6e6e6;
}

.dark-theme {
  --bg-color: #1a1a1a;
  --text-color: #e0e0e0;
  --chat-bg: #2a2a2a;
  --user-msg-bg: #3a3a3a;
  --ai-msg-bg: #303030;
  --input-bg: #3a3a3a;
  --button-bg: #0077e6;
  --button-color: #ffffff;
  --button-hover: #0066cc;
  --header-bg: #0077e6;
  --header-color: #ffffff;
  --code-bg: #2c2c2c;
  --sidebar-bg: #2a2a2a;
  --sidebar-hover: #383838;
}

body {
  font-family: Arial, sans-serif;
  line-height: 1.4;
  color: var(--text-color);
  margin: 0;
  padding: 0;
  background-color: var(--bg-color);
  transition: all 0.3s ease;
  display: flex;
}

.toggle-sidebar-button {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background-color: var(--button-bg);
  color: var(--button-color);
  border: none;
  border-radius: 5px;
  padding: 5px 10px;
  font-size: 18px;
  cursor: pointer;
  transition: left 0.3s ease-in-out;
}

body.sidebar-open .toggle-sidebar-button {
  left: 260px;
  top: 5px; /* Adjust this value to align with the "Nouvelle conversation" button */
}

.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  width: 250px;
  height: 100vh;
  transition: transform 0.3s ease-in-out;
}

.sidebar.closed {
  transform: translateX(-100%);
}

.chat-container {
  flex-grow: 1;
  background-color: var(--chat-bg);
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
  margin-left: 0;
  transition: margin-left 0.3s ease-in-out;
}

body.sidebar-open .chat-container {
  margin-left: 250px;
}

@media (max-width: 768px) {
  body {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    height: 30vh;
    transform: translateY(-100%);
  }

  .sidebar.closed {
    transform: translateY(-100%);
  }

  body.sidebar-open .chat-container {
    margin-left: 0;
    margin-top: 30vh;
  }

  body.sidebar-open .toggle-sidebar-button {
    left: 10px;
    top: calc(30vh - 40px); /* Adjust this value for mobile view */
  }
}

.chat-header {
  background-color: var(--header-bg);
  color: var(--header-color);
  padding: 10px 10px 10px 50px; /* Added left padding */
  text-align: center;
  font-size: 1.1em;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 10px;
}

.message {
  margin-bottom: 6px;
  padding: 6px;
  border-radius: 5px;
  max-width: 85%;
}

.user-message {
  background-color: var(--user-msg-bg);
  margin-left: auto;
}

.ai-message {
  background-color: var(--ai-msg-bg);
  white-space: pre-wrap;
  line-height: 1.2;
}

.chat-input {
  display: flex;
  padding: 10px;
  background-color: var(--input-bg);
}

#user-input {
  flex-grow: 1;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 14px;
  background-color: var(--input-bg);
  color: var(--text-color);
}

#send-button {
  background-color: var(--button-bg);
  color: var(--button-color);
  border: none;
  padding: 8px 15px;
  margin-left: 5px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

#send-button:hover {
  background-color: var(--button-hover);
}

.typing-indicator {
  display: none;
  font-style: italic;
  color: #888;
  margin-top: 5px;
}

#theme-toggle {
  background: none;
  border: none;
  color: var(--header-color);
  cursor: pointer;
  font-size: 1.1em;
}

.ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4, .ai-message h5, .ai-message h6 {
  margin-top: 0;
  margin-bottom: 0.3em;
  font-weight: bold;
}

.ai-message h1 { font-size: 1.3em; }
.ai-message h2 { font-size: 1.1em; }
.ai-message h3 { font-size: 1em; }

.ai-message strong {
  font-weight: bold;
}

.ai-message em {
  font-style: italic;
}

.ai-message ul, .ai-message ol {
  padding-left: 15px;
  margin-bottom: 0.3em;
}

.ai-message li {
  margin-bottom: 0.2em;
}

.ai-message code {
  font-family: monospace;
  background-color: var(--code-bg);
  padding: 1px 3px;
  border-radius: 3px;
}

.ai-message pre {
  background-color: #1e1e1e;
  color: #d4d4d4;
  padding: 10px;
  border-radius: 5px;
  overflow-x: auto;
  margin-bottom: 10px;
}

.ai-message pre code {
  background-color: transparent;
  color: inherit;
  padding: 0;
}

.hljs {
  background: #1e1e1e;
  color: #ffffff; 
}

.hljs-keyword,
.hljs-selector-tag,
.hljs-literal,
.hljs-section,
.hljs-link,
.hljs-attribute {
  color: #ff6b6b; /* Red for attributes */
}

.hljs-string {
  color: #69db7c; /* Green for attribute values */
}

.hljs-tag,
.hljs-name,
.hljs-built_in,
.hljs-selector-id,
.hljs-selector-class {
  color: #ffffff; /* White for general tags */
}

.hljs-comment,
.hljs-quote,
.hljs-meta {
  color: #6a9955; /* Keeping comments in a different color */
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

.ai-message blockquote {
  border-left: 3px solid var(--button-bg);
  padding-left: 8px;
  margin-left: 0;
  color: #777;
  margin-bottom: 0.3em;
}

.ai-message p {
  margin-bottom: 0.3em;
}

.ai-message > *:last-child {
  margin-bottom: 0;
}

#new-conversation {
  display: block;
  width: 100%;
  padding: 10px;
  background-color: var(--button-bg);
  color: var(--button-color);
  border: none;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 10px;
}

#new-conversation:hover {
  background-color: var(--button-hover);
}
</style>
</head>
<body>
  <button id="toggle-sidebar" class="toggle-sidebar-button">‚ò∞</button>
  <div class="sidebar closed">
    <button id="new-conversation" class="sidebar-button">Nouvelle conversation</button>
    <ul id="conversation-list" class="conversation-list">
      <!-- Les conversations seront ajout√©es ici -->
    </ul>
  </div>
  <div class="chat-container">
    <div class="chat-header">
      <span>Assistant IA Am√©lior√©</span>
      <button id="theme-toggle">üåì</button>
    </div>
    <div class="chat-messages" id="chat-messages">
      <!-- Les messages seront ins√©r√©s ici -->
    </div>
    <div class="typing-indicator" id="typing-indicator">L'IA est en train d'√©crire...</div>
    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Tapez votre message ici...">
      <button id="send-button">Envoyer</button>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
  <script>
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const typingIndicator = document.getElementById('typing-indicator');
    const themeToggle = document.getElementById('theme-toggle');
    const newConversationButton = document.getElementById('new-conversation');
    const conversationList = document.getElementById('conversation-list');
    const toggleSidebarButton = document.getElementById('toggle-sidebar');
    const sidebar = document.querySelector('.sidebar');
    const body = document.body;

    const API_URL = 'https://api.deepinfra.com/v1/openai/chat/completions';
    const API_KEY = 'sI1UE9Tf1NQ10VP5nVOvCze98ks5PjVY';

    let conversationHistory = [];
    let conversations = [];
    let currentConversationIndex = -1;
    let lastScrollPosition = 0;
    let isUserScrolling = false;

    function saveConversationsToLocalStorage() {
      localStorage.setItem('conversations', JSON.stringify(conversations));
    }

    function loadConversationsFromLocalStorage() {
      const savedConversations = localStorage.getItem('conversations');
      if (savedConversations) {
        conversations = JSON.parse(savedConversations);
        updateConversationList();
      }
    }

    function addMessage(content, isUser = false) {
      if (!chatMessages) {
        console.error('Chat messages container not found');
        return;
      }

      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(isUser ? 'user-message' : 'ai-message');
      
      if (isUser) {
        messageDiv.textContent = content;
      } else {
        try {
          messageDiv.innerHTML = marked(content, {
            highlight: function(code, lang) {
              if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return hljs.highlightAuto(code).value;
            }
          });
          
          messageDiv.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
          });
        } catch (error) {
          console.error('Error rendering message:', error);
          messageDiv.textContent = content;
        }
      }
      
      chatMessages.appendChild(messageDiv);
      if (!isUserScrolling) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    function saveConversation() {
      if (currentConversationIndex === -1) {
        currentConversationIndex = conversations.length;
        conversations.push({
          title: conversationHistory[0].content.substring(0, 30) + '...',
          messages: [...conversationHistory]
        });
      } else {
        conversations[currentConversationIndex].messages = [...conversationHistory];
      }
      updateConversationList();
      saveConversationsToLocalStorage(); // Ajoutez cette ligne
    }

    function updateConversationList() {
      conversationList.innerHTML = '';
      conversations.forEach((conv, index) => {
        const li = document.createElement('li');
        li.className = 'conversation-item';
        li.textContent = conv.title;
        li.onclick = () => loadConversation(index);
        
        const deleteIcon = document.createElement('span');
        deleteIcon.className = 'delete-icon';
        deleteIcon.textContent = 'üóëÔ∏è';
        deleteIcon.onclick = (e) => {
          e.stopPropagation();
          deleteConversation(index);
        };
        
        li.appendChild(deleteIcon);
        conversationList.appendChild(li);
      });
    }

    function loadConversation(index) {
      currentConversationIndex = index;
      conversationHistory = [...conversations[index].messages];
      chatMessages.innerHTML = '';
      conversationHistory.forEach(msg => addMessage(msg.content, msg.role === 'user'));
    }

    function deleteConversation(index) {
      conversations.splice(index, 1);
      if (currentConversationIndex === index) {
        currentConversationIndex = -1;
        conversationHistory = [];
        chatMessages.innerHTML = '';
      } else if (currentConversationIndex > index) {
        currentConversationIndex--;
      }
      updateConversationList();
      saveConversationsToLocalStorage(); // Ajoutez cette ligne
    }

    async function sendMessage() {
      const userMessage = userInput.value.trim();
      if (userMessage === '') return;

      addMessage(userMessage, true);
      userInput.value = '';

      conversationHistory.push({ role: "user", content: userMessage });

      if (typingIndicator) {
        typingIndicator.style.display = 'block';
      }

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: "meta-llama/Meta-Llama-3.1-405B-Instruct",
            stream: true,
            messages: [
              { role: "system", content: "Vous √™tes un assistant IA avanc√© capable de structurer vos r√©ponses avec des paragraphes concis, des points lorsque n√©cessaire, et des sauts de ligne appropri√©s pour une meilleure lisibilit√©. Utilisez le format Markdown pour structurer vos r√©ponses, y compris les titres, le texte en gras, les listes et le formatage de code pour HTML et Python. Assurez-vous que vos r√©ponses sont agr√©ables √† lire et bien d√©taill√©es tout en maintenant une structure compacte. R√©pondez toujours en fran√ßais." },
              ...conversationHistory
            ]
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let aiResponse = '';
        let aiMessageDiv = document.createElement('div');
        aiMessageDiv.classList.add('message', 'ai-message');
        chatMessages.appendChild(aiMessageDiv);

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.split('\n');
          
          for (const line of lines) {
            if (line.startsWith('data:')) {
              try {
                const data = JSON.parse(line.slice(5));
                if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                  const content = data.choices[0].delta.content;
                  aiResponse += content;
                  aiMessageDiv.innerHTML = marked(aiResponse, {
                    highlight: function(code, lang) {
                      if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                      }
                      return hljs.highlightAuto(code).value;
                    }
                  });
                  aiMessageDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                  });
                  if (!isUserScrolling && chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                  }
                }
              } catch (e) {
                console.error('Erreur lors de l\'analyse JSON:', e);
              }
            }
          }
        }

        conversationHistory.push({ role: "assistant", content: aiResponse });
        if (typingIndicator) {
          typingIndicator.style.display = 'none';
        }
        saveConversation();
      } catch (error) {
        console.error('Erreur:', error);
        addMessage('D√©sol√©, une erreur s\'est produite lors du traitement de votre demande. Veuillez r√©essayer.');
        if (typingIndicator) {
          typingIndicator.style.display = 'none';
        }
      }
    }

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      themeToggle.textContent = document.body.classList.contains('dark-theme') ? '‚òÄÔ∏è' : 'üåì';
    });

    toggleSidebarButton.addEventListener('click', () => {
      sidebar.classList.toggle('closed');
      body.classList.toggle('sidebar-open');
    });

    chatMessages.addEventListener('scroll', () => {
      isUserScrolling = true;
      lastScrollPosition = chatMessages.scrollTop;
    });

    chatMessages.addEventListener('mouseleave', () => {
      isUserScrolling = false;
    });

    newConversationButton.addEventListener('click', () => {
      currentConversationIndex = -1;
      conversationHistory = [];
      chatMessages.innerHTML = '';
      addMessage(`# Nouvelle conversation

Bonjour ! Je suis votre assistant IA am√©lior√©. Comment puis-je vous aider aujourd'hui ?

Je suis pr√™t √† discuter de n'importe quel sujet et √† r√©pondre √† vos questions de mani√®re claire et structur√©e. N'h√©sitez pas √† me poser des questions sur divers sujets, je ferai de mon mieux pour vous fournir des r√©ponses bien organis√©es et faciles √† lire.`);
    });

    addMessage(`# Bienvenue dans votre assistant IA am√©lior√©

Bonjour ! Je suis ravi de vous aider aujourd'hui.

N'h√©sitez pas √† me poser des questions sur n'importe quel sujet. Je suis l√† pour vous aider !`);
    
    function adjustLayoutForScreenSize() {
      if (window.innerWidth <= 768) {
        sidebar.classList.add('closed');
        body.classList.remove('sidebar-open');
      }
    }

    window.addEventListener('resize', adjustLayoutForScreenSize);
    adjustLayoutForScreenSize();
    
    try {
      document.addEventListener('DOMContentLoaded', (event) => {
        loadConversationsFromLocalStorage();
        if (typeof hljs !== 'undefined' && hljs.highlightAll) {
          hljs.highlightAll();
        } else {
          console.warn('highlight.js is not available');
        }
      });
    } catch (error) {
      console.error('Error in DOMContentLoaded event:', error);
    }
  </script>
</body>
</html>